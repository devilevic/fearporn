<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>fearporn.world</title>
  <link rel="stylesheet" href="/style.css" />
  <script src="/theme.js" defer></script>
</head>
<body>
  <header class="site-header">
    <div class="header-inner">
      <div class="header-row">
        <div class="brand-wrap">
          <h1 class="brand">
            fearporn<span class="brand-world">.world</span>
          </h1>
          <p class="tagline">bringing out the worst humanity has to offer</p>
        </div>

        <button id="themeToggle" class="theme-btn" type="button" aria-label="Toggle theme">
          <span class="theme-icon">üåì</span>
          <span class="theme-label">Theme</span>
        </button>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div id="articles"></div>

    <nav class="pagination" aria-label="Pagination">
      <button id="prevBtn" class="page-btn" type="button">‚Üê Prev</button>
      <span id="pageInfo" class="page-info"></span>
      <button id="nextBtn" class="page-btn" type="button">Next ‚Üí</button>
    </nav>
  </main>

<script>
(() => {
  const PAGE_SIZE = 10;
  const qs = new URLSearchParams(window.location.search);
  let page = Math.max(1, parseInt(qs.get("page") || "1", 10));

  const articlesEl = document.getElementById("articles");
  const prevBtn = document.getElementById("prevBtn");
  const nextBtn = document.getElementById("nextBtn");
  const pageInfo = document.getElementById("pageInfo");

  function stripTrailingSource(text) {
    if (!text) return "";
    const lines = text.replace(/\r\n/g, "\n").split("\n");
    while (lines.length && !lines[lines.length - 1].trim()) lines.pop();
    while (lines.length && /^source\s*:/i.test(lines[lines.length - 1].trim())) {
      lines.pop();
      while (lines.length && !lines[lines.length - 1].trim()) lines.pop();
    }
    return lines.join("\n").trim();
  }

  function renderArticles(items) {
    articlesEl.innerHTML = "";
    if (!items || !items.length) {
      articlesEl.innerHTML = '<div class="card"><p>No articles yet.</p></div>';
      return;
    }

    for (const a of items) {
      const card = document.createElement("article");
      card.className = "card";

      const title = document.createElement("h3");
      title.className = "article-title";
      title.textContent = a.title || "(untitled)";
      card.appendChild(title);

      const meta = document.createElement("div");
      meta.className = "meta";
      if (a.published_at) {
        try { meta.textContent = new Date(a.published_at).toLocaleString(); } catch {}
      }
      card.appendChild(meta);

      const summary = document.createElement("pre");
      summary.className = "summary";
      summary.textContent = stripTrailingSource(a.summary || "");
      card.appendChild(summary);

      const source = document.createElement("div");
      source.className = "source-line";
      const domain = a.source_domain || a.source_name || "source";

      const link = document.createElement("a");
      link.href = a.url;
      link.target = "_blank";
      link.rel = "noopener noreferrer";
      link.textContent = domain;

      source.appendChild(document.createTextNode("Source: "));
      source.appendChild(link);
      card.appendChild(source);

      articlesEl.appendChild(card);
    }
  }

  async function load() {
    const offset = (page - 1) * PAGE_SIZE;

    pageInfo.textContent = `Page ${page}`;
    prevBtn.disabled = page <= 1;
    nextBtn.disabled = true;

    const res = await fetch(`/api/articles?limit=${PAGE_SIZE}&offset=${offset}`);
    const items = await res.json();

    renderArticles(items);
    nextBtn.disabled = !items || items.length < PAGE_SIZE;
  }

  prevBtn.addEventListener("click", () => {
    if (page <= 1) return;
    page -= 1;
    window.location.search = `?page=${page}`;
  });

  nextBtn.addEventListener("click", () => {
    page += 1;
    window.location.search = `?page=${page}`;
  });

  load().catch(err => {
    articlesEl.innerHTML = '<div class="card"><p>Failed to load articles.</p></div>';
    console.error(err);
  });
})();
</script>
</body>
</html>