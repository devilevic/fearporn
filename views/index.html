<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>fearporn.world</title>

  <link rel="stylesheet" href="/style.css" />

  <!-- Plausible Analytics -->
  <script
    defer
    data-domain="fearporn.world"
    src="https://plausible.io/js/script.js">
  </script>
</head>

<body class="theme-dark">
  <header>
    <div class="header-inner">
      <div class="header-row">

        <div class="brand-block">
          <div class="brand">
            fearporn<span class="brand-dot">.world</span>
          </div>
          <div class="tagline">
            bringing out the worst humanity has to offer
          </div>
        </div>

        <button id="themeToggle" class="theme-toggle" type="button">
          <span class="theme-icon">ðŸŒ™</span>
          <span class="theme-label">Dark</span>
        </button>

      </div>
    </div>
  </header>

  <main class="wrap">
    <div id="feed"></div>
    <div id="pagination" style="text-align:center; margin:40px 0;"></div>
  </main>

  <script src="/theme.js"></script>

  <script>
    const PAGE_SIZE = 10;

    const params = new URLSearchParams(window.location.search);
    const page = Math.max(1, parseInt(params.get("page") || "1", 10));
    const offset = (page - 1) * PAGE_SIZE;

    function escapeHtml(s){
      return String(s||"")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#39;");
    }

    function formatStamp(article){
      const cat = (article.category || "news").toLowerCase();
      const dt = article.summarized_at || article.created_at || article.published_at;
      if(!dt) return cat;

      const d = new Date(dt);
      const opts = { month:"short", day:"2-digit" };
      const datePart = d.toLocaleDateString("en-US", opts);
      const hh = String(d.getHours()).padStart(2,"0");
      const mm = String(d.getMinutes()).padStart(2,"0");
      return `${cat} \u2022 ${datePart}, ${hh}:${mm}`;
    }

    function renderPagination(currentPage, totalPages){
      const p = document.getElementById("pagination");
      p.innerHTML = "";

      if (totalPages <= 1) return;

      const WINDOW = 6;
      const start = Math.max(1, currentPage - WINDOW);
      const end = Math.min(totalPages, currentPage + WINDOW);

      function link(label, pageNum, active = false){
        const a = document.createElement("a");
        a.href = `/?page=${pageNum}`;
        a.textContent = label;
        a.style.color = "#cc4f00";
        a.style.margin = "0 6px";
        if(active){
          a.style.fontWeight = "700";
          a.style.pointerEvents = "none";
        }
        return a;
      }

      function dots(){
        const s = document.createElement("span");
        s.textContent = "â€¦";
        s.style.margin = "0 6px";
        return s;
      }

      if(currentPage > 1){
        p.appendChild(link("â€¹", currentPage - 1));
      }

      if(start > 1){
        p.appendChild(link("1", 1));
        if(start > 2) p.appendChild(dots());
      }

      for(let i = start; i <= end; i++){
        p.appendChild(link(i, i, i === currentPage));
      }

      if(end < totalPages){
        if(end < totalPages - 1) p.appendChild(dots());
        p.appendChild(link(totalPages, totalPages));
      }

      if(currentPage < totalPages){
        p.appendChild(link("â€º", currentPage + 1));
      }
    }

    async function load(){
      const feed = document.getElementById("feed");
      feed.innerHTML = "";

      const res = await fetch("/api/articles");
      const all = await res.json();

      const total = Array.isArray(all) ? all.length : 0;
      const totalPages = Math.ceil(total / PAGE_SIZE);

      if(totalPages > 0 && page > totalPages){
        window.location.search = `?page=${totalPages}`;
        return;
      }

      const data = Array.isArray(all)
        ? all.slice(offset, offset + PAGE_SIZE)
        : [];

      if(data.length === 0){
        feed.innerHTML = `
          <div class="card">
            <div class="meta">No summarized articles yet.</div>
          </div>
        `;
        renderPagination(page, totalPages);
        return;
      }

      for(const a of data){
        const domain = a.source_domain || new URL(a.url).hostname.replace(/^www\./,"");
        const metaLine = formatStamp(a);

        feed.insertAdjacentHTML("beforeend", `
          <article class="card">
            <div class="meta">
              <span class="pill">${escapeHtml(metaLine)}</span>
            </div>
            <div class="title">${escapeHtml(a.title)}</div>
            <p class="summary">${escapeHtml(a.summary)}</p>
            <div class="source">
              Source:
              <a href="${escapeHtml(a.url)}" target="_blank" rel="noopener noreferrer">
                ${escapeHtml(domain)}
              </a>
            </div>
          </article>
        `);
      }

      renderPagination(page, totalPages);
    }

    load();
  </script>
</body>
</html>