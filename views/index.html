<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>fearporn.world</title>
  <link rel="stylesheet" href="/style.css" />
</head>

<body class="theme-dark">
  <header>
    <div class="header-inner">
      <div class="header-row">

        <div class="brand-block">
          <div class="brand">
            fearporn<span class="brand-dot">.world</span>
          </div>
          <div class="tagline">
            bringing out the worst humanity has to offer
          </div>
        </div>

        <button id="themeToggle" class="theme-toggle" type="button">
          <span class="theme-icon">ðŸŒ™</span>
          <span class="theme-label">Dark</span>
        </button>

      </div>
    </div>
  </header>

  <main class="wrap">
    <div id="feed"></div>
    <div id="pagination" style="text-align:center; margin:40px 0;"></div>
  </main>

  <script src="/theme.js"></script>

  <script>
    const PAGE_SIZE = 10;
    const params = new URLSearchParams(window.location.search);
    const page = Math.max(1, parseInt(params.get("page") || "1", 10));
    const offset = (page - 1) * PAGE_SIZE;

    function escapeHtml(s){
      return String(s||"")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#39;");
    }

    function formatStamp(article){
      const cat = (article.category || "news").toLowerCase();
      const dt = article.summarized_at || article.created_at || article.published_at;
      if(!dt) return cat;

      const d = new Date(dt);
      const opts = { month:"short", day:"2-digit" };
      const datePart = d.toLocaleDateString("en-US", opts);
      const hh = String(d.getHours()).padStart(2,"0");
      const mm = String(d.getMinutes()).padStart(2,"0");
      return `${cat} \u2022 ${datePart}, ${hh}:${mm}`;
    }

    function renderPagination(total){
      const pages = Math.ceil(total / PAGE_SIZE);
      if(pages <= 1) return;

      const p = document.getElementById("pagination");
      let html = "";

      if(page > 1){
        html += `<a href="?page=${page-1}" style="color:#cc4f00; margin:0 8px;">â€¹</a>`;
      }

      const start = Math.max(1, page - 4);
      const end = Math.min(pages, page + 4);

      if(start > 1){
        html += `<a href="?page=1" style="color:#cc4f00; margin:0 6px;">1</a>`;
        if(start > 2) html += `<span style="margin:0 6px;">â€¦</span>`;
      }

      for(let i = start; i <= end; i++){
        if(i === page){
          html += `<span style="color:#cc4f00; font-weight:700; margin:0 6px;">${i}</span>`;
        } else {
          html += `<a href="?page=${i}" style="color:#cc4f00; margin:0 6px;">${i}</a>`;
        }
      }

      if(end < pages){
        if(end < pages - 1) html += `<span style="margin:0 6px;">â€¦</span>`;
        html += `<a href="?page=${pages}" style="color:#cc4f00; margin:0 6px;">${pages}</a>`;
      }

      if(page < pages){
        html += `<a href="?page=${page+1}" style="color:#cc4f00; margin:0 8px;">â€º</a>`;
      }

      p.innerHTML = html;
    }

    async function load(){
      const feed = document.getElementById("feed");
      feed.innerHTML = "";

      const metaRes = await fetch("/_debug");
      const meta = await metaRes.json();

      // IMPORTANT: backend currently ignores limit/offset, so fetch all then slice locally
      const res = await fetch(`/api/articles`);
      const all = await res.json();

      const data = Array.isArray(all)
        ? all.slice(offset, offset + PAGE_SIZE)
        : [];

      if(!Array.isArray(data) || data.length === 0){
        feed.innerHTML = `<div class="card"><div class="meta">No summarized articles yet.</div></div>`;
        renderPagination(meta.total || 0);
        return;
      }

      for(const a of data){
        const domain = a.source_domain || new URL(a.url).hostname.replace(/^www\./,"");
        const metaLine = formatStamp(a);

        feed.insertAdjacentHTML("beforeend", `
          <article class="card">
            <div class="meta">
              <span class="pill">${escapeHtml(metaLine)}</span>
            </div>
            <div class="title">${escapeHtml(a.title)}</div>
            <p class="summary">${escapeHtml(a.summary)}</p>
            <div class="source">
              Source:
              <a href="${escapeHtml(a.url)}" target="_blank" rel="noopener noreferrer">
                ${escapeHtml(domain)}
              </a>
            </div>
          </article>
        `);
      }

      renderPagination(meta.total || 0);
    }

    load();
  </script>
</body>
</html>