<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>fearporn.world</title>

    <!-- Your "perfect" CSS file -->
    <link rel="stylesheet" href="/style.css" />

    <!-- Theme toggle logic (icon + label) -->
    <script src="/theme.js" defer></script>
  </head>

  <body>
    <div class="wrap">
      <header class="top">
        <div class="brand">
          <h1 class="logo">
            fearporn<span class="logo-accent">.world</span>
          </h1>
          <div class="tagline">bringing out the worst humanity has to offer</div>
        </div>

        <div class="actions">
          <button id="themeToggle" class="btn" type="button">
            <span class="theme-icon" aria-hidden="true">ðŸŒ™</span>
            <span class="theme-label">Dark</span>
          </button>
        </div>
      </header>

      <main>
        <div id="list" class="list"></div>
        <div id="pager" class="pager"></div>
      </main>
    </div>

    <script>
      const ITEMS_PER_PAGE = 10;

      function escapeHtml(s) {
        return String(s ?? "")
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }

      function nl2br(s) {
        return escapeHtml(s).replaceAll("\n", "<br/>");
      }

      function getPageFromUrl() {
        const u = new URL(window.location.href);
        const p = parseInt(u.searchParams.get("page") || "1", 10);
        return Number.isFinite(p) && p > 0 ? p : 1;
      }

      function setPageInUrl(page) {
        const u = new URL(window.location.href);
        if (page <= 1) u.searchParams.delete("page");
        else u.searchParams.set("page", String(page));
        window.history.pushState({}, "", u);
      }

      function buildPager(totalItems, page, onGo) {
        const totalPages = Math.max(1, Math.ceil(totalItems / ITEMS_PER_PAGE));
        const pager = document.getElementById("pager");
        pager.innerHTML = "";

        if (totalPages <= 1) return;

        function addBtn(label, targetPage, disabled = false, active = false) {
          const b = document.createElement("button");
          b.type = "button";
          b.className = "page-btn" + (active ? " active" : "");
          b.textContent = label;
          b.disabled = disabled;
          b.addEventListener("click", () => onGo(targetPage));
          pager.appendChild(b);
        }

        function addEllipsis() {
          const s = document.createElement("span");
          s.className = "page-ellipsis";
          s.textContent = "â€¦";
          pager.appendChild(s);
        }

        // Prev
        addBtn("Prev", Math.max(1, page - 1), page === 1);

        // Pages (compact with ellipses)
        const pagesToShow = new Set([1, totalPages, page, page - 1, page + 1, page - 2, page + 2]);
        const sorted = [...pagesToShow].filter(p => p >= 1 && p <= totalPages).sort((a,b)=>a-b);

        let last = 0;
        for (const p of sorted) {
          if (last && p > last + 1) addEllipsis();
          addBtn(String(p), p, false, p === page);
          last = p;
        }

        // Next
        addBtn("Next", Math.min(totalPages, page + 1), page === totalPages);
      }

      function render(articles, page) {
        const totalItems = articles.length;
        const totalPages = Math.max(1, Math.ceil(totalItems / ITEMS_PER_PAGE));
        const safePage = Math.min(Math.max(1, page), totalPages);

        const start = (safePage - 1) * ITEMS_PER_PAGE;
        const pageItems = articles.slice(start, start + ITEMS_PER_PAGE);

        const list = document.getElementById("list");
        list.innerHTML = pageItems
          .map((a) => {
            const title = escapeHtml(a.title);
            const category = escapeHtml(a.category || "news");
            const created = escapeHtml(a.created_at || "");
            const summary = nl2br(a.summary || "");
            const sourceDomain = escapeHtml(a.source_domain || a.source_name || "source");

            // Title is NOT a link (matches your old styling)
            // Only the bottom "Source: domain" is the link
            return `
              <article class="card">
                <div class="meta">
                  <span class="pill">${category}</span>
                  <span class="dot">â€¢</span>
                  <span class="date">${created}</span>
                </div>

                <div class="title">${title}</div>

                <div class="summary">${summary}</div>

                <div class="source">
                  <span class="source-label">Source:</span>
                  <a class="source-link" href="${escapeHtml(a.url)}" target="_blank" rel="noopener noreferrer">
                    ${sourceDomain}
                  </a>
                </div>
              </article>
            `;
          })
          .join("");

        buildPager(totalItems, safePage, (p) => {
          setPageInUrl(p);
          render(articles, p);
          window.scrollTo({ top: 0, behavior: "smooth" });
        });
      }

      async function main() {
        // Fetch up to 100 newest (your API already does this)
        const res = await fetch("/api/articles?limit=100");
        const articles = await res.json();

        const page = getPageFromUrl();
        render(Array.isArray(articles) ? articles : [], page);

        window.addEventListener("popstate", () => {
          render(Array.isArray(articles) ? articles : [], getPageFromUrl());
        });
      }

      main().catch((e) => {
        const list = document.getElementById("list");
        list.innerHTML = `<div class="card"><div class="summary">Failed to load articles: ${escapeHtml(
          e?.message || String(e)
        )}</div></div>`;
      });
    </script>

    <style>
      /* Minimal additions just for pagination + small logo accent */
      .logo-accent { color: #cc4f00; }
      .pager {
        display: flex;
        justify-content: center;
        gap: 8px;
        margin: 18px 0 8px;
        flex-wrap: wrap;
      }
      .page-btn {
        background: transparent;
        border: 1px solid var(--border);
        color: var(--text);
        padding: 6px 10px;
        border-radius: 10px;
        cursor: pointer;
      }
      .page-btn:hover { filter: brightness(1.08); }
      .page-btn.active {
        border-color: var(--title);
        color: var(--title);
      }
      .page-btn:disabled { opacity: 0.45; cursor: default; }
      .page-ellipsis { opacity: 0.6; padding: 6px 4px; }
      /* Make theme label look like DARK/LIGHT without touching theme.js */
      .theme-label { text-transform: uppercase; letter-spacing: .06em; }
    </style>
  </body>
</html>