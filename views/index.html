<link rel="stylesheet" href="/public/style.css" />

<div id="feed"></div>
<div id="pager" class="pager"></div>

<script>
  const PAGE_SIZE = 10;
  let ALL = [];

  function getPageFromUrl() {
    const url = new URL(window.location.href);
    const p = parseInt(url.searchParams.get("page") || "1", 10);
    return Number.isFinite(p) && p > 0 ? p : 1;
  }

  function setPageInUrl(page) {
    const url = new URL(window.location.href);
    url.searchParams.set("page", String(page));
    window.history.pushState({}, "", url);
  }

  function escapeHtml(s) {
    return String(s ?? "")
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  function renderPage(page) {
    const total = ALL.length;
    const totalPages = Math.max(1, Math.ceil(total / PAGE_SIZE));
    const safePage = Math.min(Math.max(1, page), totalPages);

    const start = (safePage - 1) * PAGE_SIZE;
    const slice = ALL.slice(start, start + PAGE_SIZE);

    const feed = document.getElementById("feed");
    feed.innerHTML = slice
      .map(
        (a) => `
        <article class="post">
          <h2 class="title">${escapeHtml(a.title)}</h2>
          <div class="summary">${escapeHtml(a.summary)}</div>
        </article>
      `
      )
      .join("");

    renderPager(safePage, totalPages);
  }

  function renderPager(page, totalPages) {
    const pager = document.getElementById("pager");
    if (!pager) return;

    // If only 1 page, hide pager
    if (totalPages <= 1) {
      pager.innerHTML = "";
      return;
    }

    // Window of page numbers
    const windowSize = 7;
    let start = Math.max(1, page - Math.floor(windowSize / 2));
    let end = Math.min(totalPages, start + windowSize - 1);
    start = Math.max(1, end - windowSize + 1);

    const parts = [];

    const btn = (label, p, disabled = false, active = false) => `
      <button
        class="page-btn ${active ? "active" : ""}"
        data-page="${p}"
        ${disabled ? "disabled" : ""}
        aria-current="${active ? "page" : "false"}"
      >${label}</button>
    `;

    parts.push(btn("Prev", page - 1, page === 1));

    if (start > 1) {
      parts.push(btn("1", 1, false, page === 1));
      if (start > 2) parts.push(`<span class="page-ellipsis">…</span>`);
    }

    for (let p = start; p <= end; p++) {
      parts.push(btn(String(p), p, false, p === page));
    }

    if (end < totalPages) {
      if (end < totalPages - 1) parts.push(`<span class="page-ellipsis">…</span>`);
      parts.push(btn(String(totalPages), totalPages, false, page === totalPages));
    }

    parts.push(btn("Next", page + 1, page === totalPages));

    pager.innerHTML = parts.join("");

    pager.querySelectorAll("button[data-page]").forEach((b) => {
      b.addEventListener("click", () => {
        const p = parseInt(b.getAttribute("data-page"), 10);
        if (!Number.isFinite(p)) return;
        setPageInUrl(p);
        renderPage(p);
        window.scrollTo({ top: 0, behavior: "smooth" });
      });
    });
  }

  async function load() {
    // Ask for more than 10 so we can paginate client-side.
    const res = await fetch("/api/articles?limit=200");
    ALL = await res.json();

    renderPage(getPageFromUrl());
  }

  window.addEventListener("popstate", () => {
    renderPage(getPageFromUrl());
  });

  load();
</script>