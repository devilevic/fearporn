<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>fearporn.world</title>
  <link rel="stylesheet" href="/style.css" />
</head>

<body>
  <header class="header-row">
    <div class="header-inner">
      <div class="header-top">
        <div>
          <div class="tagline">bringing out the worst humanity has to offer</div>
          <h1 style="margin:0; line-height:1;">
            fearporn.<span style="color:#cc4f00;">world</span>
          </h1>
        </div>

        <button id="themeToggle" class="theme-toggle" type="button" aria-label="Toggle theme">
          <span class="theme-icon">☾</span>
          <span class="theme-label">Theme</span>
        </button>
      </div>
    </div>
  </header>

  <main>
    <div id="articles"></div>
    <div class="pager" id="pager" style="text-align:center;"></div>
  </main>

  <script src="/theme.js"></script>
  <script>
    const PAGE_SIZE = 10;

    function esc(s) {
      return String(s || "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function getPage() {
      const p = parseInt(new URLSearchParams(location.search).get("page") || "1", 10);
      return Number.isFinite(p) && p > 0 ? p : 1;
    }

    function setPage(p) {
      const url = new URL(location.href);
      url.searchParams.set("page", String(p));
      location.href = url.toString();
    }

    function renderArticles(items) {
      const el = document.getElementById("articles");
      el.innerHTML = "";

      for (const a of items) {
        const card = document.createElement("section");
        card.className = "card";

        const title = document.createElement("div");
        title.className = "title";
        title.textContent = a.title || "(untitled)";
        card.appendChild(title);

        if (a.published_at || a.created_at || a.category) {
          const meta = document.createElement("div");
          meta.className = "meta";

          const parts = [];
          if (a.category) parts.push(esc(a.category));
          if (a.published_at) parts.push(new Date(a.published_at).toLocaleString());
          else if (a.created_at) parts.push(esc(a.created_at));

          meta.innerHTML = parts.join(" · ");
          card.appendChild(meta);
        }

        const summary = document.createElement("div");
        summary.className = "summary";
        summary.textContent = a.summary || "";
        card.appendChild(summary);

        const src = document.createElement("div");
        src.className = "source";
        const href = a.source_url || a.url;
        const label = a.source_domain || a.source_name || "source";
        src.innerHTML = `Source: <a href="${esc(href)}" target="_blank" rel="noopener noreferrer">${esc(label)}</a>`;
        card.appendChild(src);

        el.appendChild(card);
      }
    }

    function renderPager(page, pages) {
      const pager = document.getElementById("pager");
      pager.innerHTML = "";

      if (pages <= 1) return;

      function addLink(text, p, active = false) {
        if (active) {
          const b = document.createElement("b");
          b.textContent = text;
          pager.appendChild(b);
          return;
        }
        const a = document.createElement("a");
        a.href = "javascript:void(0)";
        a.textContent = text;
        a.onclick = () => setPage(p);
        pager.appendChild(a);
      }

      // Prev
      if (page > 1) addLink("‹ Prev", page - 1);

      // show a compact window around current page
      const windowSize = 7;
      let start = Math.max(1, page - Math.floor(windowSize / 2));
      let end = Math.min(pages, start + windowSize - 1);
      start = Math.max(1, end - windowSize + 1);

      if (start > 1) {
        addLink("1", 1, page === 1);
        if (start > 2) {
          const dots = document.createElement("b");
          dots.textContent = "…";
          pager.appendChild(dots);
        }
      }

      for (let p = start; p <= end; p++) addLink(String(p), p, p === page);

      if (end < pages) {
        if (end < pages - 1) {
          const dots = document.createElement("b");
          dots.textContent = "…";
          pager.appendChild(dots);
        }
        addLink(String(pages), pages, page === pages);
      }

      // Next
      if (page < pages) addLink("Next ›", page + 1);
    }

    async function load() {
      const page = getPage();
      const res = await fetch(`/api/articles?page=${page}&limit=${PAGE_SIZE}`);
      const data = await res.json();

      // expected: { items, total, page, pages, limit }
      renderArticles(data.items || []);
      renderPager(data.page || page, data.pages || 1);
    }

    load().catch(err => {
      document.getElementById("articles").innerHTML =
        `<div class="card"><div class="title">Error</div><div class="summary">${esc(err.message || err)}</div></div>`;
    });
  </script>
</body>
</html>