<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>fearporn</title>
  <link rel="stylesheet" href="/style.css" />
</head>
<body class="theme-dark">
  <header>
    <div class="header-inner">
      <div class="header-row">
        <div class="brand">fearporn</div>

        <button id="themeToggle" class="theme-toggle" type="button">
          <span class="theme-icon">ðŸŒ™</span>
          <span class="theme-label">Dark</span>
        </button>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div id="feed"></div>
  </main>

  <script src="/theme.js"></script>
  <script>
    function escapeHtml(s){
      return String(s||"")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#39;");
    }

    function formatStamp(article){
      // display "category â€¢ Dec 14, 09:31"
      const cat = (article.category || "news").toLowerCase();
      const dt = article.summarized_at || article.created_at || article.published_at;
      if(!dt) return cat;

      const d = new Date(dt);
      const opts = { month:"short", day:"2-digit" };
      const datePart = d.toLocaleDateString("en-US", opts);
      const hh = String(d.getHours()).padStart(2,"0");
      const mm = String(d.getMinutes()).padStart(2,"0");
      return `${cat} \u2022 ${datePart}, ${hh}:${mm}`;
    }

    async function load(){
      const el = document.getElementById("feed");
      el.innerHTML = "";

      const res = await fetch("/api/articles", { cache:"no-store" });
      const data = await res.json();

      if(!Array.isArray(data) || data.length === 0){
        el.innerHTML = `<div class="card"><div class="meta">No summarized articles yet.</div></div>`;
        return;
      }

      for(const a of data){
        const domain = a.source_domain ? a.source_domain : (new URL(a.url)).hostname.replace(/^www\./,"");
        const meta = formatStamp(a);

        el.insertAdjacentHTML("beforeend", `
          <article class="card">
            <div class="meta">
              <span class="pill">${escapeHtml(meta)}</span>
            </div>
            <div class="title">${escapeHtml(a.title)}</div>
            <p class="summary">${escapeHtml(a.summary)}</p>
            <div class="source">Source: <a href="${escapeHtml(a.url)}" target="_blank" rel="noopener noreferrer">${escapeHtml(domain)}</a></div>
          </article>
        `);
      }
    }

    load();
  </script>
</body>
</html>