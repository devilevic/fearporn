<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>fearporn.world</title>

    <!-- IMPORTANT: use /public/... so CSS always loads -->
    <link rel="stylesheet" href="/style.css" />
  </head>
  <body class="theme-dark">
    <div class="wrap">
      <header class="top">
        <div>
          <div class="brand">
            fearporn<span class="dotworld">.world</span>
          </div>
          <div class="tagline">bringing out the worst humanity has to offer</div>
        </div>
        <button id="themeBtn" class="themeBtn">Theme</button>
      </header>

      <main>
        <div id="feed"></div>
        <!-- Pagination container (styled by .pager in your CSS) -->
        <div id="pager" class="pager"></div>
      </main>
    </div>

    <script>
      // --- Theme toggle (unchanged behavior) ---
      const themeBtn = document.getElementById("themeBtn");
      const body = document.body;

      function setTheme(theme) {
        body.classList.remove("theme-dark", "theme-light");
        body.classList.add(theme);
        localStorage.setItem("theme", theme);
      }

      const savedTheme = localStorage.getItem("theme") || "theme-dark";
      setTheme(savedTheme);

      themeBtn.addEventListener("click", () => {
        const next = body.classList.contains("theme-dark")
          ? "theme-light"
          : "theme-dark";
        setTheme(next);
      });

      // --- Pagination ---
      const PAGE_SIZE = 10;
      const feed = document.getElementById("feed");
      const pager = document.getElementById("pager");

      function getPageFromUrl() {
        const u = new URL(window.location.href);
        const p = parseInt(u.searchParams.get("page") || "1", 10);
        return Number.isFinite(p) && p > 0 ? p : 1;
      }

      function setPageInUrl(page) {
        const u = new URL(window.location.href);
        u.searchParams.set("page", String(page));
        window.location.href = u.toString(); // simple + reliable
      }

      function escapeHtml(str) {
        return String(str)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }

      function renderArticles(items) {
        if (!items.length) {
          feed.innerHTML = `<div class="pending">No articles yet.</div>`;
          return;
        }

        feed.innerHTML = items
          .map((a) => {
            const title = escapeHtml(a.title || "");
            const summary = escapeHtml(a.summary || "");
            const url = escapeHtml(a.url || "#");
            const category = escapeHtml(a.category || "");
            const createdAt = escapeHtml(a.created_at || "");
            const sourceDomain = escapeHtml(a.source_domain || "");

            return `
              <article class="card">
                <div class="meta">
                  <span class="pill">${category || "news"}</span>
                  <span class="dot">•</span>
                  <span>${createdAt}</span>
                </div>

                <h2 class="title"><a href="${url}" target="_blank" rel="noopener noreferrer">${title}</a></h2>

                <div class="summary">${summary.replaceAll("\n", "<br/>")}</div>

                <div class="source">Source: <a href="https://${sourceDomain}" target="_blank" rel="noopener noreferrer">${sourceDomain}</a></div>
              </article>
            `;
          })
          .join("\n");
      }

      function renderPager(currentPage, totalPages) {
        if (totalPages <= 1) {
          pager.innerHTML = "";
          return;
        }

        const parts = [];

        if (currentPage > 1) {
          parts.push(`<a href="?page=${currentPage - 1}">Prev</a>`);
        } else {
          parts.push(`<span>Prev</span>`);
        }

        // show up to 9 page links with ellipses
        const windowSize = 7;
        let start = Math.max(1, currentPage - Math.floor(windowSize / 2));
        let end = Math.min(totalPages, start + windowSize - 1);
        start = Math.max(1, end - windowSize + 1);

        if (start > 1) parts.push(`<a href="?page=1">1</a>`, `<span>…</span>`);

        for (let p = start; p <= end; p++) {
          if (p === currentPage) parts.push(`<b>${p}</b>`);
          else parts.push(`<a href="?page=${p}">${p}</a>`);
        }

        if (end < totalPages)
          parts.push(`<span>…</span>`, `<a href="?page=${totalPages}">${totalPages}</a>`);

        if (currentPage < totalPages) {
          parts.push(`<a href="?page=${currentPage + 1}">Next</a>`);
        } else {
          parts.push(`<span>Next</span>`);
        }

        pager.innerHTML = parts.join("");
      }

      async function load() {
        const page = getPageFromUrl();

        const res = await fetch("/api/articles?limit=500");
        const all = await res.json();

        const totalPages = Math.max(1, Math.ceil(all.length / PAGE_SIZE));
        const safePage = Math.min(page, totalPages);

        const start = (safePage - 1) * PAGE_SIZE;
        const slice = all.slice(start, start + PAGE_SIZE);

        renderArticles(slice);
        renderPager(safePage, totalPages);
      }

      load().catch((e) => {
        feed.innerHTML = `<div class="pending">Failed to load articles.</div>`;
        pager.innerHTML = "";
      });
    </script>

    <style>
      /* only if you already had this before; safe to keep inline */
      .dotworld { color: #cc4f00; }
    </style>
  </body>
</html>